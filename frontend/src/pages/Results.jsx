import { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";

export default function Results() {
  const navigate = useNavigate();
  const [data, setData] = useState(null);
  const [error, setError] = useState(null);

  useEffect(() => {
    // Try WebSocket first for real-time updates
    const ws = new WebSocket("ws://localhost:3000");

    ws.onopen = () => {
      console.log("Connected to live updates");
    };

    ws.onmessage = (event) => {
      try {
        const message = JSON.parse(event.data);
        if (message.type === "update" && message.data) {
          setData(message.data);
          setError(null);
        }
      } catch (err) {
        console.error("Error parsing WebSocket message:", err);
      }
    };

    ws.onerror = (error) => {
      console.error("WebSocket error:", error);
      // Fallback to HTTP request
      fetch("http://localhost:3000/api/diagnostics")
        .then((res) => {
          if (!res.ok) throw new Error("No diagnostic report available");
          return res.json();
        })
        .then(setData)
        .catch((err) => setError(err.message));
    };

    ws.onclose = () => {
      console.log("Disconnected from live updates");
    };

    return () => {
      if (ws.readyState === WebSocket.OPEN) {
        ws.close();
      }
    };
  }, []);

  const downloadReport = () => {
    if (!data) return;
    const reportContent = `SYSTEM HEALTH REPORT
Generated: ${new Date().toLocaleString()}

OVERALL SUMMARY
===============
Health Status: ${data.overall.health}
Health Score: ${data.overall.total_score}/100
Estimated Remaining Life: ${data.overall.longevity_years} years
Sustainability: ${data.overall.sustainability}
Reusable: ${data.overall.reusable ? "YES" : "NO"}

HARDWARE MODULE STATUS
======================
${Object.entries(data.components)
  .map(([key, value]) => `${key.toUpperCase()}: ${value.health} (Score: ${value.score})`)
  .join('\n')}

---
Generated by Device Health Monitor`;

    const blob = new Blob([reportContent], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `health-report-${new Date().toISOString().split('T')[0]}.txt`;
    link.click();
    URL.revokeObjectURL(url);
  };

  const downloadInsights = () => {
    const insightsContent = `AI-GENERATED HEALTH INSIGHTS
Generated: ${new Date().toLocaleString()}

=================================

OVERALL STATUS: ${data.overall.health}

LIFESPAN & SUSTAINABILITY:
- Estimated Remaining Life: ${data.overall.longevity_years} years
- Sustainability: ${data.overall.sustainability}
- Reusable: ${data.overall.reusable ? "YES" : "NO"}

COMPONENT BREAKDOWN:
${Object.entries(data.components)
  .map(([key, value]) => `- ${key.toUpperCase()}: ${value.health}`)
  .join('\n')}

RECOMMENDATIONS:
- Review components showing FAIR or POOR status
- Monitor system performance regularly
- Schedule maintenance as needed

---
Generated by Device Health Monitor`;

    const blob = new Blob([insightsContent], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `health-insights-${new Date().toISOString().split('T')[0]}.txt`;
    link.click();
    URL.revokeObjectURL(url);
  };

  if (error) {
    return (
      <div className="container">
        <p className="muted">{error}</p>
      </div>
    );
  }

  if (!data) {
    return (
      <div className="container">
        <p className="muted">Loading report‚Ä¶</p>
      </div>
    );
  }

  const { components, overall } = data;

  const getHealthColor = (health) => {
    const lower = health.toLowerCase();
    if (lower === "excellent" || lower === "optimized") return "#10B981";
    if (lower === "good") return "#3B82F6";
    if (lower === "fair" || lower === "warning") return "#F59E0B";
    if (lower === "poor" || lower === "critical") return "#EF4444";
    return "#9AA4B2";
  };

  return (
    <div className="container">
      {/* Header with action */}
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: 40 }}>
        <div>
          <p className="label">SYSTEM HEALTH REPORT</p>
          <h1 style={{ fontSize: 32, margin: "8px 0 0 0" }}>System Health Report</h1>
          <p className="muted" style={{ marginTop: 8 }}>
            Generated {new Date().toLocaleString()}
          </p>
        </div>
        <button className="btn btn-primary" style={{ whiteSpace: "nowrap" }} onClick={downloadReport}>‚¨á Download Report</button>
      </div>

      {/* Overall summary */}
      <div
        className="grid"
        style={{ gridTemplateColumns: "repeat(auto-fit, minmax(220px, 1fr))", marginTop: 24, marginBottom: 40 }}
      >
        <div className="card">
          <p className="label">OVERALL DEVICE HEALTH</p>
          <h2 style={{ color: getHealthColor(overall.health), marginTop: 12, fontSize: 28 }}>
            {overall.health}
          </h2>
        </div>

        <div className="card">
          <p className="label">HEALTH SCORE</p>
          <div style={{ marginTop: 12, display: "flex", alignItems: "baseline", gap: 8 }}>
            <h2 style={{ fontSize: 28, margin: 0 }}>{overall.total_score}</h2>
            <span className="muted" style={{ fontSize: 18 }}>/100</span>
          </div>
        </div>

        <div className="card">
          <p className="label">EST. REMAINING LIFE</p>
          <h2 style={{ marginTop: 12, fontSize: 28 }}>{overall.longevity_years} yrs</h2>
          <p className="muted" style={{ marginTop: 6 }}>Based on current health</p>
        </div>

        <div className="card">
          <p className="label">SUSTAINABILITY</p>
          <h2 style={{ marginTop: 12, fontSize: 28 }}>{overall.sustainability}</h2>
          <p className="muted" style={{ marginTop: 6 }}>
            Reusable: {overall.reusable ? "YES" : "NO"}
          </p>
        </div>
      </div>

      {/* AI Generated Insights */}
      <div className="card" style={{ marginBottom: 40, borderLeft: "4px solid #2F81F7" }}>
        <p className="label">ü§ñ AI-Generated Health Insights</p>
        <p className="muted" style={{ marginTop: 12 }}>
          {data.overall.health === "GOOD" && "System is in good condition. All critical components are functioning normally."}
          {data.overall.health === "FAIR" && "System is functional but may require maintenance checks. Review individual component status below for details."}
          {data.overall.health === "POOR" && "System requires attention. Please review the component status and consider maintenance or replacement."}
        </p>
      </div>

      {/* Components */}
      <h2 style={{ marginBottom: 24 }}>Hardware Module Status</h2>

      <div
        className="grid"
        style={{
          gridTemplateColumns: "repeat(auto-fit, minmax(200px, 1fr))",
        }}
      >
        {Object.entries(components).map(([key, value]) => {
          const breakdown = data.componentBreakdowns?.[key];
          const icon = breakdown?.icon || "üì¶";
          const reusable = breakdown?.reusability?.reusable;

          return (
            <div
              className="card component-card clickable-card"
              key={key}
              onClick={() => navigate(`/component/${key}`)}
              role="button"
              tabIndex={0}
              onKeyDown={(e) => {
                if (e.key === "Enter" || e.key === " ") navigate(`/component/${key}`);
              }}
            >
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
                <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                  <span style={{ fontSize: 20 }}>{icon}</span>
                  <p className="label" style={{ margin: 0 }}>{key.toUpperCase()}</p>
                </div>
                <div style={{ width: 12, height: 12, borderRadius: "50%", background: getHealthColor(value.health) }}></div>
              </div>
              <p style={{ margin: "8px 0", fontSize: 12, color: getHealthColor(value.health) }}>{value.health}</p>
              <p className="muted" style={{ margin: "4px 0", fontSize: 12 }}>Score: {value.score}</p>
              {reusable !== undefined && (
                <p style={{ margin: "8px 0 0 0", fontSize: 11, color: reusable ? "#10B981" : "#EF4444" }}>
                  {reusable ? "‚ôªÔ∏è Reusable" : "‚ùå Not Reusable"}
                </p>
              )}
              <p className="muted" style={{ fontSize: 10, marginTop: 12 }}>Click for details ‚Üí</p>
            </div>
          );
        })}
      </div>

      {/* Reusability Summary */}
      {data.reusabilitySummary && (
        <div className="card" style={{ marginTop: 40, borderLeft: "4px solid #2F81F7" }}>
          <p className="label">‚ôªÔ∏è REUSABILITY SUMMARY</p>
          <p style={{ marginTop: 12, fontSize: 16 }}>
            <strong>{data.reusabilitySummary.reusableCount}</strong> out of {data.reusabilitySummary.totalComponents} components are reusable.
          </p>
          <div style={{ marginTop: 16 }}>
            {data.reusabilitySummary.breakdown.map((item, i) => (
              <div key={i} style={{ marginBottom: 8, fontSize: 13 }}>
                <span style={{ color: item.reusable ? "#10B981" : "#EF4444", marginRight: 8 }}>
                  {item.reusable ? "‚úÖ" : "‚ùå"}
                </span>
                <strong>{item.component.toUpperCase()}</strong>: {item.verdict}
                <span className="muted" style={{ marginLeft: 8, fontSize: 11 }}>({item.confidence}% confidence)</span>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Actions */}
      <div style={{ marginTop: 60, textAlign: "center", paddingTop: 40, borderTop: "1px solid #1F2A44" }}>
        <div style={{ display: "flex", gap: 12, justifyContent: "center", flexWrap: "wrap" }}>
          <button className="btn btn-secondary" onClick={downloadReport}>‚¨á Download Report</button>
          <button className="btn btn-secondary" onClick={downloadInsights}>üí° Download Insights</button>
          <button className="btn btn-secondary">üîÑ Run Analysis Again</button>
        </div>
      </div>
    </div>
  );
}
